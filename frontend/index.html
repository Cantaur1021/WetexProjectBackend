<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1080, height=1080, initial-scale=1.0, user-scalable=no" />
  <title>SureFlow Host</title>
  <style>
    :root{
      --video-bias: 0px;
      --ui-raise: 140px;
      --page-bg: #000;                 /* background remains black */
      --ui-nudge-down: 120px;
      --sf-blue:#2f6db2;
      --sf-blue-2:#3b82f6;
      --sf-green:#33b071;
      --text:#e5e7eb;                  /* brighter on black */
      --ring:rgba(47,109,178,.25);
    }
    *{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
    body{
      width:1080px;height:1080px;overflow:hidden;
      position:relative;cursor:none;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--page-bg);
    }

    .bg-video{
      position:absolute; inset:0;
      width:1080px; height:1080px;
      object-fit:cover;
      object-position:center center;
      z-index:0; pointer-events:none;
      display:block;                  /* visible during idle */
      background:#000;
    }

    .ui-overlay{
      position:absolute; inset:0; z-index:10;
      pointer-events:none;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }

    .message-display{
      position:absolute; left:50%; transform:translateX(-50%) scale(.98);
      bottom: calc(100px + var(--ui-raise));
      background:#0b1220cc; border:1px solid #1e293b; border-radius:16px;
      padding:28px 36px; width:80%; max-width:720px; text-align:center;
      backdrop-filter:blur(12px);
      opacity:0; transition:opacity .3s ease, transform .3s ease;
      box-shadow:0 8px 30px rgba(17,24,39,.25);
    }
    .message-display.active{opacity:1; transform:translateX(-50%) scale(1)}
    .message-text{color:var(--text); font-size:26px; font-weight:300; line-height:1.5; letter-spacing:.2px}
    .message-text .highlight{color:#fff; font-weight:500}

    .hidden-exit{position:absolute; top:10px; right:10px; width:50px; height:50px; opacity:0; cursor:pointer; z-index:9999}
  </style>
</head>
<body>
  <!-- Background video -->
  <video
    id="bgVideo"
    class="bg-video"
    src="/static/video/video.webm"
    muted
    preload="auto"
    playsinline
  ></video>

  <div class="hidden-exit" onclick="window.close()"></div>

  <div class="ui-overlay">
    <!-- Message (same position as before) -->
    <div class="message-display" id="messageDisplay">
      <div class="message-text" id="messageText"></div>
    </div>
  </div>

  <script>
    const messageDisplay = document.getElementById('messageDisplay');
    const messageText = document.getElementById('messageText');
    const bgVideo = document.getElementById('bgVideo');

    let appState = 'idle'; // 'idle' | 'dispensing'
    let timers = [];
    let ws, wsReady = false, wsRetryTimer;

    // Idle loop pause between loops (ms)
    const LOOP_PAUSE_MS = 10000;

    // Internals for idle loop-with-pause
    let loopEndedHandler = null;
    let loopPauseTimer = null;

    function show(el){ el.classList.add('active'); }
    function hide(el){ el.classList.remove('active'); }
    function clearTimers(){ timers.forEach(t=>clearTimeout(t)); timers=[]; }

    function clearVideoHandlers(){
      if (loopEndedHandler && bgVideo) {
        bgVideo.removeEventListener('ended', loopEndedHandler);
        loopEndedHandler = null;
      }
      if (loopPauseTimer){
        clearTimeout(loopPauseTimer);
        loopPauseTimer = null;
      }
    }

    // Idle behavior: play once, pause on last frame for LOOP_PAUSE_MS, repeat
    function startLoopingWithPause(){
      if (!bgVideo) return;
      clearVideoHandlers();
      bgVideo.loop = false;
      try { bgVideo.currentTime = 0; } catch {}
      loopEndedHandler = () => {
        if (appState !== 'idle') return;
        bgVideo.pause(); // hold final frame
        loopPauseTimer = setTimeout(() => {
          if (appState !== 'idle') return;
          try { bgVideo.currentTime = 0; } catch {}
          bgVideo.play().catch(()=>{});
        }, LOOP_PAUSE_MS);
      };
      bgVideo.addEventListener('ended', loopEndedHandler);
      bgVideo.play().catch(()=>{});
    }

    function toIdle(){
      clearTimers();
      appState = 'idle';
      hide(messageDisplay);
      startLoopingWithPause();
    }

    // Pause at the last frame immediately (regardless of current position)
    function pauseAtFinalFrameThen(callback){
      if (!bgVideo) { callback && callback(); return; }
      const EPS = 0.04; // seconds before end to reliably land a frame

      // Stop idle loop from restarting mid-seek
      clearVideoHandlers();
      bgVideo.loop = false;

      const seekToEnd = () => {
        const dur = bgVideo.duration;
        if (!isFinite(dur) || isNaN(dur) || dur <= 0) {
          bgVideo.pause();
          callback && callback();
          return;
        }
        const target = Math.max(dur - EPS, 0);
        const onSeeked = () => {
          bgVideo.removeEventListener('seeked', onSeeked);
          try { bgVideo.pause(); } catch {}
          callback && callback();
        };
        bgVideo.addEventListener('seeked', onSeeked, { once: true });
        try { bgVideo.currentTime = target; } catch {
          bgVideo.pause();
          callback && callback();
        }
      };

      if (isFinite(bgVideo.duration) && !isNaN(bgVideo.duration) && bgVideo.duration > 0) {
        seekToEnd();
      } else {
        const onMeta = () => {
          bgVideo.removeEventListener('loadedmetadata', onMeta);
          seekToEnd();
        };
        bgVideo.addEventListener('loadedmetadata', onMeta, { once: true });
        // Nudge load, then pause
        try { bgVideo.play().then(()=>{ bgVideo.pause(); }).catch(()=>{}); } catch {}
      }
    }

    function startDispenseFlow(){
      if (appState !== 'idle') return;   // prevent re-entry
      appState = 'dispensing';

      // Show thank-you message (same position as before)
      messageText.innerHTML = `Here's a chocolate, <span class="highlight">thank you for visiting!</span>`;
      show(messageDisplay);

      // Immediately jump to final frame and pause
      pauseAtFinalFrameThen(() => {
        // Inform backend right away that we're at the end-of-flow
        wsSend({ type:'NoChocolate' });

        // Keep the message up for 10s, then return to idle loop-with-pause
        timers.push(setTimeout(() => {
          toIdle();
        }, 10000));
      });
    }

    /* ---------- WebSocket ---------- */
    const BACKEND_WS_URL =
      (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';

    function initWS(){
      try{
        ws = new WebSocket(BACKEND_WS_URL);
        ws.addEventListener('open', ()=>{ wsReady=true; });
        ws.addEventListener('close', ()=>{ wsReady=false; clearTimeout(wsRetryTimer); wsRetryTimer=setTimeout(initWS,1500); });
        ws.addEventListener('error', ()=>{ wsReady=false; try{ws.close()}catch{} });
        ws.addEventListener('message', (evt)=>{
          try{
            const data = JSON.parse(evt.data);
            // Accept either the new 'StartDispense' or legacy 'GreetingTransition'
            if ((data.type === 'StartDispense' || data.type === 'GreetingTransition') && appState === 'idle') {
              startDispenseFlow();
            }
          }catch{}
        });
      }catch{
        wsReady=false; clearTimeout(wsRetryTimer); wsRetryTimer=setTimeout(initWS,2000);
      }
    }
    function wsSend(obj){
      if (wsReady && ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
    }

    // Boot: idle video loop-with-pause
    toIdle();
    initWS();

    // In case autoplay gets cranky
    function tryPlay() { bgVideo && bgVideo.play().catch(()=>{}); }
    bgVideo && bgVideo.addEventListener('canplay', tryPlay, { once:true });
    bgVideo && bgVideo.addEventListener('loadeddata', tryPlay, { once:true });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tryPlay(); }, false);
  </script>
</body>
</html>
