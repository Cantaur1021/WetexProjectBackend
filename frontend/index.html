<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1080, height=1080, initial-scale=1.0, user-scalable=no" />
  <title>SureFlow Host</title>
  <style>
    :root{
      --video-bias: 0px;
      --ui-raise: 140px;
      --page-bg: #000;                 /* idle is black now */
      --ui-nudge-down: 120px;
      --sf-blue:#2f6db2;
      --sf-blue-2:#3b82f6;
      --sf-green:#33b071;
      --text:#e5e7eb;                  /* brighter on black */
      --ring:rgba(47,109,178,.25);
    }
    *{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
    body{
      width:1080px;height:1080px;overflow:hidden;
      position:relative;cursor:none;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--page-bg);
    }

    .bg-video{
      position:absolute; inset:0;
      width:1080px; height:1080px;
      object-fit:cover;
      object-position:center center;
      z-index:0; pointer-events:none;
      display:none;                    /* hidden while idle (black) */
      background:#000;
    }

    .ui-overlay{
      position:absolute; inset:0; z-index:10;
      pointer-events:none;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }

    /* Removed question UI entirely */

    .message-display{
      position:absolute; left:50%; transform:translateX(-50%) scale(.98);
      bottom: calc(100px + var(--ui-raise));
      background:#0b1220cc; border:1px solid #1e293b; border-radius:16px;
      padding:28px 36px; width:80%; max-width:720px; text-align:center;
      backdrop-filter:blur(12px);
      opacity:0; transition:opacity .3s ease, transform .3s ease;
      box-shadow:0 8px 30px rgba(17,24,39,.25);
    }
    .message-display.active{opacity:1; transform:translateX(-50%) scale(1)}
    .message-text{color:var(--text); font-size:26px; font-weight:300; line-height:1.5; letter-spacing:.2px}
    .message-text .highlight{color:#fff; font-weight:500}

    .hidden-exit{position:absolute; top:10px; right:10px; width:50px; height:50px; opacity:0; cursor:pointer; z-index:9999}
  </style>
</head>
<body>
  <!-- Background video (idle hidden, shown only during dispense) -->
  <video
    id="bgVideo"
    class="bg-video"
    src="/static/video/video.webm"
    muted
    preload="auto"
    playsinline
  ></video>

  <div class="hidden-exit" onclick="window.close()"></div>

  <div class="ui-overlay">
    <!-- Messages (same position as before) -->
    <div class="message-display" id="messageDisplay">
      <div class="message-text" id="messageText"></div>
    </div>
  </div>

  <script>
    const messageDisplay = document.getElementById('messageDisplay');
    const messageText = document.getElementById('messageText');
    const bgVideo = document.getElementById('bgVideo');

    let appState = 'idle'; // 'idle' | 'dispensing' | 'post'
    let timers = [];
    let ws, wsReady = false, wsRetryTimer;

    function show(el){ el.classList.add('active'); }
    function hide(el){ el.classList.remove('active'); }
    function clearTimers(){ timers.forEach(t=>clearTimeout(t)); timers=[]; }

    function toIdle(){
      clearTimers();
      appState = 'idle';
      hide(messageDisplay);
      if (bgVideo){
        bgVideo.pause();
        bgVideo.currentTime = 0;
        bgVideo.style.display = 'none'; // black screen
      }
    }

    function startDispenseFlow(){
      // Set message immediately (same position as before)
      messageText.innerHTML = `Heres a chocolate, <span class="highlight">thank you for visiting</span>`;
      show(messageDisplay);

      // Show video and play once
      if (bgVideo){
        bgVideo.style.display = 'block';
        try { bgVideo.currentTime = 0; } catch {}
        bgVideo.loop = false;

        const onEnded = () => {
          bgVideo.removeEventListener('ended', onEnded);
          // Video finished -> chocolate dispensed
          wsSend({ type:'NoChocolate' }); // triggers robot moving back & GPIO on backend

          // Keep the thank-you text for 10s, then back to idle (black)
          timers.push(setTimeout(() => {
            toIdle();
          }, 10000));
        };

        bgVideo.addEventListener('ended', onEnded);
        bgVideo.play().catch(()=>{ /* ignore autoplay errors; kiosk flags should cover */ });
      }

      appState = 'dispensing';
    }

    /* ---------- WebSocket ---------- */
    const BACKEND_WS_URL =
      (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';

    function initWS(){
      try{
        ws = new WebSocket(BACKEND_WS_URL);
        ws.addEventListener('open', ()=>{ wsReady=true; });
        ws.addEventListener('close', ()=>{ wsReady=false; clearTimeout(wsRetryTimer); wsRetryTimer=setTimeout(initWS,1500); });
        ws.addEventListener('error', ()=>{ wsReady=false; try{ws.close()}catch{} });
        ws.addEventListener('message', (evt)=>{
          try{
            const data = JSON.parse(evt.data);
            // Accept either the new 'StartDispense' or legacy 'GreetingTransition'
            if ((data.type === 'StartDispense' || data.type === 'GreetingTransition') && appState === 'idle') {
              startDispenseFlow();
            }
          }catch{}
        });
      }catch{
        wsReady=false; clearTimeout(wsRetryTimer); wsRetryTimer=setTimeout(initWS,2000);
      }
    }
    function wsSend(obj){
      if (wsReady && ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
    }

    // Boot
    toIdle();
    initWS();

    // Try to recover play if the browser blocked it
    function tryPlay() { bgVideo && bgVideo.play().catch(()=>{}); }
    bgVideo && bgVideo.addEventListener('canplay', tryPlay, { once:true });
    bgVideo && bgVideo.addEventListener('loadeddata', tryPlay, { once:true });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tryPlay(); }, false);
  </script>
</body>
</html>
